<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Lesen lernen</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; background-color: #f0f8ff; }
        #app-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; text-align: center; }
        #top-ui-panel { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 10; width: 80%; }
        #level-display { font-size: 22px; font-weight: bold; background-color: rgba(255, 255, 255, 0.8); padding: 5px 15px; border-radius: 15px; }
        #progress-display { font-size: 16px; font-weight: normal; margin-top: 5px; display: none; }
        #word-display { font-size: 15vw; font-weight: bold; }
        #feedback-display { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 20px; font-weight: bold; height: 30px; }
        .side-button { position: fixed; top: 100px; width: 60px; height: calc(100vh - 120px); color: white; border: none; font-size: 30px; cursor: pointer; display: flex; justify-content: center; align-items: center; writing-mode: vertical-rl; text-orientation: mixed; border-radius: 15px; z-index: 9; }
        #left-button { left: 15px; background-color: #008CBA; }
        #right-button { right: 15px; background-color: #4CAF50; }
        body.test-mode #right-button { display: none; }
        #hamburger-button { position: fixed; top: 15px; left: 15px; font-size: 28px; cursor: pointer; background: none; border: none; z-index: 101; width: 40px; height: 40px; }
        #side-menu { position: fixed; top: 0; left: -35vw; width: 33.33vw; height: 100vh; background-color: #ffffff; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: left 0.3s ease-in-out; z-index: 100; display: flex; flex-direction: column; }
        #side-menu.open { left: 0; }
        #menu-header { padding: 15px; padding-top: 60px; border-bottom: 1px solid #ccc; }
        #menu-header button { font-size: 16px; width: 100%; text-align: left; background: #eee; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
        #menu-content-wrapper { display: flex; flex: 1; min-height: 0; }
        .menu-column { width: 50%; display: flex; flex-direction: column; border-right: 1px solid #eee; }
        .menu-column:last-child { border-right: none; }
        #menu-progress { text-align: center; font-weight: bold; padding: 12px; font-size: 14px; background-color: #f8f8f8; }
        .scrollable-list { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; position: relative; }
        .list-item:hover { background-color: #f0f0f0; }
        .list-item.locked { color: #aaa; cursor: not-allowed; }
        .list-item.locked:hover { background-color: transparent; }
        .list-item.completed::after { content: '‚úì'; color: green; font-weight: bold; position: absolute; right: 15px; }
        #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 200; }
        #success-message { color: white; font-size: 10vw; font-weight: bold; text-shadow: 0 0 20px #ffc107; }
        #timer-container { position: fixed; top: 65px; left: 50%; transform: translateX(-50%); width: 42%; height: 8px; background-color: #e0e0e0; border-radius: 4px; overflow: hidden; display: none; }
        #timer-bar {
            width: 100%;
            height: 100%;
            background-color: #2196F3;
            border-radius: 4px;
            /* ‚òÖ‚òÖ‚òÖ Die feste Zeit wurde hier entfernt ‚òÖ‚òÖ‚òÖ */
            transition: width linear;
        }
    </style>
</head>
<body>
    <div id="top-ui-panel"><div id="level-display">Stufe 1</div><div id="timer-container"><div id="timer-bar"></div></div><div id="progress-display">0 von 10</div></div>
    <div id="app-container"><div id="word-display">Start</div></div>
    <div id="feedback-display"></div>
    <button id="hamburger-button">‚ò∞</button>
    <div id="side-menu"><div id="menu-header"><button>‚öôÔ∏è Einstellungen</button></div><div id="menu-content-wrapper"><div class="menu-column"><div id="menu-progress"></div><div id="level-list" class="scrollable-list"></div></div><div class="menu-column"><div id="custom-list" class="scrollable-list"></div></div></div></div>
    <button id="left-button" class="side-button">Test</button>
    <button id="right-button" class="side-button">N√§chstes Wort</button>
    <div id="success-overlay"><div id="success-message"></div></div>

    <script>
        const ADMIN_PASSWORD = "1234";
        // ‚òÖ‚òÖ‚òÖ HIER IST DIE ZENTRALE EINSTELLUNG ‚òÖ‚òÖ‚òÖ
        const TEST_DURATION_SECONDS = 3; // <-- √ÑNDERE NUR DIESE ZAHL

        let adminTapCount = 0; let adminTapTimer;
        const stufen = [ ["der", "die", "und", "in", "den", "von", "zu", "das", "mit", "sich"], ["des", "auf", "f√ºr", "ist", "im", "dem", "nicht", "ein", "eine", "als"], ["auch", "es", "an", "werden", "aus", "er", "hat", "dass", "sie", "nach"] /* ... */ ];
        const customLists = { "Orte": ["Hannover", "Hamburg", "Berlin", "M√ºnchen", "K√∂ln"], "Namen": ["Lisa", "Markus"] };
        let aktuelleStufe = 1, hoechsteStufe = 1, currentTestType = 'stufe', currentCustomList = '', wordsOfCurrentLevel = [], wordsToTest = [], initialTestWords = [], currentWord = '', currentMode = 'training', totalWordsInTest = 0;
        let timer, failedAttempts = 0, attemptInProgress = false, soundStarted = false;
        
        const wordDisplay = document.getElementById('word-display'), levelDisplay = document.getElementById('level-display'), topUiPanel = document.getElementById('top-ui-panel'), progressDisplay = document.getElementById('progress-display'), feedbackDisplay = document.getElementById('feedback-display'), leftButton = document.getElementById('left-button'), rightButton = document.getElementById('right-button'), hamburgerButton = document.getElementById('hamburger-button'), sideMenu = document.getElementById('side-menu'), menuProgress = document.getElementById('menu-progress'), levelList = document.getElementById('level-list'), customListContainer = document.getElementById('custom-list'), successOverlay = document.getElementById('success-overlay'), successMessage = document.getElementById('success-message'), timerContainer = document.getElementById('timer-container'), timerBar = document.getElementById('timer-bar');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; const recognition = new SpeechRecognition(); recognition.lang = 'de-DE'; recognition.interimResults = false;
        
        function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
        function speak(text){if(!('speechSynthesis'in window))return;const u=new SpeechSynthesisUtterance(text);u.lang='de-DE';u.rate=0.85;window.speechSynthesis.cancel();window.speechSynthesis.speak(u)}
        function showNewTrainingWord(){if(wordsOfCurrentLevel.length===0)return;let a=wordsOfCurrentLevel.filter(w=>w!==currentWord);if(a.length===0)a=wordsOfCurrentLevel;currentWord=a[Math.floor(Math.random()*a.length)];wordDisplay.textContent=currentWord;speak(currentWord)}
        function ladeStufe(s,i=false){currentTestType='stufe';aktuelleStufe=s;wordsOfCurrentLevel=stufen[s-1];levelDisplay.textContent=`Stufe ${s}`;if(!i)localStorage.setItem('aktuelleLeseStufe',s)}
        function ladeCustomList(l){currentTestType='custom';currentCustomList=l;wordsOfCurrentLevel=customLists[l];levelDisplay.textContent=l}
        function testAbschliessen(){clearTimeout(timer);let s="üéâ Super gemacht! üéâ";if(currentTestType==='stufe'){const n=aktuelleStufe+1;if(n>hoechsteStufe){hoechsteStufe=n;localStorage.setItem('hoechsteLeseStufe',n)}if(n>stufen.length){s="üéâ ALLES GESCHAFFT! üéâ"}else{s=`üéÜ Stufe ${n}!!! üéÜ`}setTimeout(()=>{successOverlay.style.display='none';if(n<=stufen.length){ladeStufe(n);switchToTrainingMode()}},3000)}else{localStorage.setItem(`customList_${currentCustomList}_completed`,'true');setTimeout(()=>{successOverlay.style.display='none';switchToTrainingMode()},3000)}successMessage.textContent=s;successOverlay.style.display='flex'}
        function updateProgressDisplay(){progressDisplay.textContent=`${totalWordsInTest-wordsToTest.length} von ${totalWordsInTest}`}
        function switchToTestMode(){document.body.classList.add('test-mode');currentMode='test';progressDisplay.style.display='block';timerContainer.style.display='block';wordDisplay.style.color='black';feedbackDisplay.textContent='';leftButton.textContent='Training';let c=[...wordsOfCurrentLevel];if(currentTestType==='stufe'&&aktuelleStufe>1){const p=stufen.slice(0,aktuelleStufe-1).flat();shuffle(p);c.push(...p.slice(0,5))}wordsToTest=c;shuffle(wordsToTest);initialTestWords=[...wordsToTest];totalWordsInTest=wordsToTest.length;updateProgressDisplay();showNextTestWord()}
        function showNextTestWord(){if(wordsToTest.length>0){currentWord=wordsToTest[0];wordDisplay.textContent=currentWord;wordDisplay.style.color='black';feedbackDisplay.textContent='';failedAttempts=0;startTestAttempt()}else{setTimeout(testAbschliessen,500)}}
        
        function startTestAttempt() {
            if (attemptInProgress) return;
            attemptInProgress = true;
            soundStarted = false;
            feedbackDisplay.textContent = '...';
            recognition.start();
        }

        function resetTestProgress(message) {
            clearTimeout(timer);
            attemptInProgress = false;
            feedbackDisplay.textContent = message;
            wordDisplay.style.color = '#dc3545';
            wordsToTest = [...initialTestWords];
            updateProgressDisplay();
            setTimeout(showNextTestWord, 2000);
        }

        function handleUnrecognizedAttempt() {
            failedAttempts++;
            if (failedAttempts >= 2) {
                feedbackDisplay.textContent = "Versuch es mal in einem Satz! üí¨";
            } else {
                feedbackDisplay.textContent = "Nicht verstanden! Nochmal...";
            }
            setTimeout(startTestAttempt, 1500);
        }

        recognition.onaudiostart = () => {
            feedbackDisplay.textContent = 'üëÇ';
            timerBar.style.transition='none'; 
            timerBar.style.width='100%';
            
            // ‚òÖ‚òÖ‚òÖ Der Balken nutzt jetzt die zentrale Variable ‚òÖ‚òÖ‚òÖ
            setTimeout(()=>{
                timerBar.style.transitionDuration = `${TEST_DURATION_SECONDS}s`;
                timerBar.style.width='0%';
            }, 20);

            // ‚òÖ‚òÖ‚òÖ Der Logik-Timer nutzt jetzt die zentrale Variable ‚òÖ‚òÖ‚òÖ
            timer = setTimeout(() => {
                recognition.stop();
            }, (TEST_DURATION_SECONDS * 1000) + 100);
        };
        
        recognition.onsoundstart = () => { soundStarted = true; };

        recognition.onresult = (event) => {
            if (!attemptInProgress) return;
            clearTimeout(timer);
            const spokenText = event.results[0][0].transcript.trim().toLowerCase();
            let isCorrect = (spokenText === currentWord.toLowerCase());
            if (!isCorrect && failedAttempts >= 2 && spokenText.includes(currentWord.toLowerCase())) { isCorrect = true; }
            if (isCorrect) {
                feedbackDisplay.textContent = 'Super, richtig!';
                wordDisplay.style.color = '#4CAF50';
                wordsToTest.shift();
                updateProgressDisplay();
                setTimeout(showNextTestWord, 1200);
            } else {
                resetTestProgress('Falsch! Der Test startet neu.');
            }
            attemptInProgress = false;
        };
        
        recognition.onend = () => {
            if (!attemptInProgress) return;
            attemptInProgress = false;
            clearTimeout(timer);
            if (soundStarted) {
                handleUnrecognizedAttempt();
            } else {
                resetTestProgress('Still! Der Test startet neu.');
            }
        };

        recognition.onerror = (event) => { if(event.error !== 'no-speech'){ console.error("Speech Recognition Error:", event.error); feedbackDisplay.textContent = "Mikrofon-Fehler."; } };
        
        function switchToTrainingMode(){document.body.classList.remove('test-mode');clearTimeout(timer);currentMode='training';progressDisplay.style.display='none';timerContainer.style.display='none';wordDisplay.style.color='black';feedbackDisplay.textContent='';leftButton.textContent='Test';showNewTrainingWord()}
        
        // --- RESTLICHE FUNKTIONEN (unver√§ndert) ---
        hamburgerButton.addEventListener('click', ()=>{populateLevelList();populateCustomLists();sideMenu.classList.toggle('open')});
        function handleLeftButtonClick(){if(currentMode==='training'){switchToTestMode()}else{switchToTrainingMode()}}
        function handleRightButtonClick(){if(currentMode==='training'){showNewTrainingWord()}}
        leftButton.addEventListener('click',handleLeftButtonClick);rightButton.addEventListener('click',handleRightButtonClick);
        populateLevelList=function(){levelList.innerHTML='';menuProgress.textContent=`Erreicht: Stufe ${hoechsteStufe} von ${stufen.length}`;for(let i=1;i<=stufen.length;i++){const item=document.createElement('div');item.className='list-item';item.textContent=`Stufe ${i}`;if(i>hoechsteStufe){item.classList.add('locked')}else{item.addEventListener('click',()=>{ladeStufe(i,true);switchToTrainingMode();sideMenu.classList.remove('open')})}levelList.appendChild(item)}}
        populateCustomLists=function(){customListContainer.innerHTML='';for(const listenName in customLists){const item=document.createElement('div');item.className='list-item';item.textContent=listenName;if(localStorage.getItem(`customList_${listenName}_completed`)==='true'){item.classList.add('completed')}item.addEventListener('click',()=>{ladeCustomList(listenName);switchToTrainingMode();sideMenu.classList.remove('open')});customListContainer.appendChild(item)}}
        openAdminMenu=function(){const pw=prompt("Admin-Passwort eingeben:");if(pw!==ADMIN_PASSWORD){alert("Falsches Passwort.");return}const action=prompt("Aktion eingeben: 'reset' zum Zur√ºcksetzen, 'set' zum Setzen einer Stufe.");if(action&&action.toLowerCase()==='reset'){localStorage.clear();alert("Fortschritt wurde zur√ºckgesetzt!");location.reload()}else if(action&&action.toLowerCase()==='set'){const newLevel=prompt("H√∂chste freigeschaltete Stufe eingeben:");const levelNum=parseInt(newLevel);if(levelNum>0&&levelNum<=stufen.length){localStorage.setItem('hoechsteLeseStufe',levelNum);localStorage.setItem('aktuelleLeseStufe',levelNum);alert(`Fortschritt auf Stufe ${levelNum} gesetzt!`);location.reload()}else{alert("Ung√ºltige Stufennummer.")}}}
        topUiPanel.addEventListener('click',()=>{clearTimeout(adminTapTimer);adminTapCount++;if(adminTapCount>=7){adminTapCount=0;openAdminMenu()}adminTapTimer=setTimeout(()=>{adminTapCount=0},1500)});
        
        async function appStarten() { 
            const gespeicherteHoechsteStufe = localStorage.getItem('hoechsteLeseStufe'); 
            const gespeicherteAktuelleStufe = localStorage.getItem('aktuelleLeseStufe'); 
            hoechsteStufe = gespeicherteHoechsteStufe ? parseInt(gespeicherteHoechsteStufe) : 1; 
            let startStufe = gespeicherteAktuelleStufe ? parseInt(gespeicherteAktuelleStufe) : 1; 
            if (startStufe > hoechsteStufe) startStufe = hoechsteStufe; 
            ladeStufe(startStufe); 
            switchToTrainingMode(); 
        }
        
        appStarten();
    </script>
</body>
</html>