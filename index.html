<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Lesen lernen</title>
    <style>
        /* CSS bleibt unver√§ndert, mit Erg√§nzungen f√ºr den Timer */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; background-color: #f0f8ff; }
        #app-container { display: flex; justify-content: center; align-items: center; width: 100vw; height: 100vh; text-align: center; }
        #top-ui-panel { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); text-align: center; z-index: 10; cursor: pointer; width: 80%; }
        #level-display { font-size: 22px; font-weight: bold; background-color: rgba(255, 255, 255, 0.8); padding: 5px 15px; border-radius: 15px; }
        #progress-display { font-size: 16px; font-weight: normal; margin-top: 5px; display: none; }
        #word-display { font-size: 15vw; font-weight: bold; }
        #feedback-display { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 20px; font-weight: bold; height: 30px; }
        .side-button { position: fixed; top: 100px; width: 60px; height: calc(100vh - 120px); color: white; border: none; font-size: 30px; cursor: pointer; display: flex; justify-content: center; align-items: center; writing-mode: vertical-rl; text-orientation: mixed; border-radius: 15px; z-index: 9; }
        #left-button { left: 15px; background-color: #008CBA; }
        #right-button { right: 15px; background-color: #4CAF50; }
        body.test-mode #right-button { display: none; } /* Button im Testmodus ausblenden */
        #hamburger-button { position: fixed; top: 15px; left: 15px; font-size: 28px; cursor: pointer; background: none; border: none; z-index: 101; width: 40px; height: 40px; }
        #side-menu { position: fixed; top: 0; left: -35vw; width: 33.33vw; height: 100vh; background-color: #ffffff; box-shadow: 2px 0 10px rgba(0,0,0,0.2); transition: left 0.3s ease-in-out; z-index: 100; display: flex; flex-direction: column; }
        #side-menu.open { left: 0; }
        #menu-header { padding: 15px; padding-top: 60px; border-bottom: 1px solid #ccc; }
        #menu-header button { font-size: 16px; width: 100%; text-align: left; background: #eee; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
        #menu-content-wrapper { display: flex; flex: 1; min-height: 0; }
        .menu-column { width: 50%; display: flex; flex-direction: column; border-right: 1px solid #eee; }
        .menu-column:last-child { border-right: none; }
        #menu-progress { text-align: center; font-weight: bold; padding: 12px; font-size: 14px; background-color: #f8f8f8; }
        .scrollable-list { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 14px; position: relative; }
        .list-item:hover { background-color: #f0f0f0; }
        .list-item.locked { color: #aaa; cursor: not-allowed; }
        .list-item.locked:hover { background-color: transparent; }
        .list-item.completed::after { content: '‚úì'; color: green; font-weight: bold; position: absolute; right: 15px; }
        #success-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 200; }
        #success-message { color: white; font-size: 10vw; font-weight: bold; text-shadow: 0 0 20px #ffc107; }
        
        /* NEU: Stile f√ºr den Timer-Balken */
        #timer-container {
            position: fixed;
            top: 65px; /* Unter der Stufen-Anzeige */
            left: 50%;
            transform: translateX(-50%);
            width: 30%; /* Breite des Balkens */
            height: 8px; /* Schmale H√∂he */
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            display: none; /* Standardm√§√üig ausgeblendet */
        }
        #timer-bar {
            width: 100%;
            height: 100%;
            background-color: #2196F3; /* Blauer Ton */
            border-radius: 4px;
            transition: width 2s linear; /* 2 Sekunden Animation */
        }
    </style>
</head>
<body>
    <div id="top-ui-panel">
        <div id="level-display">Stufe 1</div>
        <div id="timer-container"><div id="timer-bar"></div></div> <div id="progress-display">0 von 10</div>
    </div>
    <div id="app-container"><div id="word-display">Start</div></div>
    <div id="feedback-display"></div>
    <button id="hamburger-button">‚ò∞</button>
    <div id="side-menu"><div id="menu-header"><button>‚öôÔ∏è Einstellungen</button></div><div id="menu-content-wrapper"><div class="menu-column"><div id="menu-progress"></div><div id="level-list" class="scrollable-list"></div></div><div class="menu-column"><div id="custom-list" class="scrollable-list"></div></div></div></div>
    <button id="left-button" class="side-button">Test</button>
    <button id="right-button" class="side-button">N√§chstes Wort</button>
    <div id="success-overlay"><div id="success-message"></div></div>

    <script>
        const ADMIN_PASSWORD = "1234";
        let adminTapCount = 0;
        let adminTapTimer;
        const stufen = [ ["der", "die", "und", "in", "den", "von", "zu", "das", "mit", "sich"], ["des", "auf", "f√ºr", "ist", "im", "dem", "nicht", "ein", "eine", "als"], ["auch", "es", "an", "werden", "aus", "er", "hat", "dass", "sie", "nach"], ["wird", "bei", "einer", "um", "am", "sind", "noch", "wie", "einem", "√ºber"], ["einen", "so", "zum", "war", "haben", "nur", "oder", "aber", "vor", "zur"], ["bis", "mehr", "durch", "man", "sein", "wurde", "sei", "Prozent", "hatte", "kann"], ["gegen", "vom", "k√∂nnen", "schon", "wenn", "habe", "seine", "ihre", "dann", "unter"], ["wir", "soll", "ich", "eines", "Jahr", "zwei", "Jahren", "diese", "dieser", "wieder"], ["keine", "Uhr", "seiner", "worden", "will", "zwischen", "immer", "was", "sagte", "gibt"], ["alle", "diesem", "seit", "mu√ü", "wurden", "beim", "doch", "jetzt", "waren", "drei"] /* ...restliche Stufen... */ ];
        const customLists = { "Orte": ["Hannover", "Hamburg", "Berlin", "M√ºnchen", "K√∂ln", "Deutschland"], "Namen": ["Lisa", "Markus", "Felix", "Emily"] };
        
        // --- VARIABLEN ---
        let aktuelleStufe = 1, hoechsteStufe = 1, currentTestType = 'stufe', currentCustomList = '', wordsOfCurrentLevel = [], wordsToTest = [], initialTestWords = [], currentWord = '', currentMode = 'training', wasCorrect = false, totalWordsInTest = 0;
        let timer; // NEU: Variable f√ºr den Timeout
        const wordDisplay = document.getElementById('word-display'), levelDisplay = document.getElementById('level-display'), topUiPanel = document.getElementById('top-ui-panel'), progressDisplay = document.getElementById('progress-display'), feedbackDisplay = document.getElementById('feedback-display'), leftButton = document.getElementById('left-button'), rightButton = document.getElementById('right-button'), hamburgerButton = document.getElementById('hamburger-button'), sideMenu = document.getElementById('side-menu'), menuProgress = document.getElementById('menu-progress'), levelList = document.getElementById('level-list'), customListContainer = document.getElementById('custom-list'), successOverlay = document.getElementById('success-overlay'), successMessage = document.getElementById('success-message'), timerContainer = document.getElementById('timer-container'), timerBar = document.getElementById('timer-bar');
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; const recognition = new SpeechRecognition(); recognition.lang = 'de-DE'; recognition.interimResults = false;
        
        // --- FUNKTIONEN ---
        function shuffle(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
        function speak(text) { if (!('speechSynthesis' in window)) return; const utterance = new SpeechSynthesisUtterance(text); utterance.lang = 'de-DE'; utterance.rate = 0.85; window.speechSynthesis.cancel(); window.speechSynthesis.speak(utterance); }
        function showNewTrainingWord() { if (wordsOfCurrentLevel.length === 0) return; let availableWords = wordsOfCurrentLevel.filter(word => word !== currentWord); if (availableWords.length === 0) availableWords = wordsOfCurrentLevel; const randomIndex = Math.floor(Math.random() * availableWords.length); currentWord = availableWords[randomIndex]; wordDisplay.textContent = currentWord; speak(currentWord); }
        function ladeStufe(stufenNummer, istWiederholung = false) { currentTestType = 'stufe'; aktuelleStufe = stufenNummer; wordsOfCurrentLevel = stufen[stufenNummer - 1]; levelDisplay.textContent = `Stufe ${stufenNummer}`; if (!istWiederholung) { localStorage.setItem('aktuelleLeseStufe', aktuelleStufe); } }
        function ladeCustomList(listenName) { currentTestType = 'custom'; currentCustomList = listenName; wordsOfCurrentLevel = customLists[listenName]; levelDisplay.textContent = listenName; }
        function testAbschliessen() { clearTimeout(timer); let successText = "üéâ Super gemacht! üéâ"; if (currentTestType === 'stufe') { const naechsteStufe = aktuelleStufe + 1; if (naechsteStufe > hoechsteStufe) { hoechsteStufe = naechsteStufe; localStorage.setItem('hoechsteLeseStufe', hoechsteStufe); } if (naechsteStufe > stufen.length) { successText = "üéâ ALLES GESCHAFFT! üéâ"; } else { successText = `üéÜ Stufe ${naechsteStufe}!!! üéÜ`; } setTimeout(() => { successOverlay.style.display = 'none'; if (naechsteStufe <= stufen.length) { ladeStufe(naechsteStufe); switchToTrainingMode(); } }, 3000); } else { localStorage.setItem(`customList_${currentCustomList}_completed`, 'true'); setTimeout(() => { successOverlay.style.display = 'none'; switchToTrainingMode(); }, 3000); } successMessage.textContent = successText; successOverlay.style.display = 'flex'; }
        function updateProgressDisplay() { const remainingWords = wordsToTest.length; const completedWords = totalWordsInTest - remainingWords; progressDisplay.textContent = `${completedWords} von ${totalWordsInTest}`; }
        
        function switchToTestMode() { 
            document.body.classList.add('test-mode'); // Body-Klasse f√ºr CSS hinzuf√ºgen
            currentMode = 'test'; 
            progressDisplay.style.display = 'block'; 
            timerContainer.style.display = 'block'; // Timer einblenden
            wordDisplay.style.color = 'black'; 
            feedbackDisplay.textContent = ''; 
            leftButton.textContent = 'Training'; 
            let currentTestWords = [...wordsOfCurrentLevel]; 
            if (currentTestType === 'stufe' && aktuelleStufe > 1) { 
                const previousLevels = stufen.slice(0, aktuelleStufe - 1); 
                const previousWordsPool = previousLevels.flat(); 
                shuffle(previousWordsPool); 
                const bonusWords = previousWordsPool.slice(0, 5); 
                currentTestWords.push(...bonusWords); 
            } 
            wordsToTest = currentTestWords; 
            shuffle(wordsToTest); 
            initialTestWords = [...wordsToTest]; // Kopie f√ºr den Reset speichern
            totalWordsInTest = wordsToTest.length; 
            updateProgressDisplay(); 
            showNextTestWord(); 
        }

        function showNextTestWord() {
            clearTimeout(timer); // Alten Timer l√∂schen
            if (wordsToTest.length > 0) { 
                currentWord = wordsToTest[0]; 
                wordDisplay.textContent = currentWord; 
                wordDisplay.style.color = 'black'; 
                feedbackDisplay.textContent = '';
                
                // Timer-Balken zur√ºcksetzen und Animation starten
                timerBar.style.transition = 'none'; // Animation kurz deaktivieren
                timerBar.style.width = '100%'; // Sofort auf 100% setzen
                setTimeout(() => { // N√∂tig, damit der Browser die √Ñnderung registriert
                    timerBar.style.transition = 'width 2s linear';
                    timerBar.style.width = '0%';
                }, 20);

                // Aufnahme starten und Timeout setzen
                startRecording();
                timer = setTimeout(() => {
                    recognition.stop();
                    feedbackDisplay.textContent = 'Zu langsam! N√§chstes Wort...';
                    setTimeout(showNextTestWord, 1500); // Nach kurzer Pause zum n√§chsten Wort
                }, 2000); // 2 Sekunden
            } else { 
                setTimeout(testAbschliessen, 500); 
            } 
        }
        
        recognition.onresult = (event) => {
            clearTimeout(timer); // Timer stoppen, da eine Antwort kam
            recognition.stop();
            const spokenText = event.results[0][0].transcript.trim().toLowerCase();
            
            if (spokenText === currentWord.toLowerCase()) {
                wasCorrect = true;
                feedbackDisplay.textContent = 'Super, richtig!';
                wordDisplay.style.color = '#4CAF50';
                wordsToTest.shift();
                updateProgressDisplay();
                setTimeout(showNextTestWord, 1200);
            } else {
                // Falsche Antwort: Fortschritt zur√ºcksetzen
                wasCorrect = false;
                feedbackDisplay.textContent = 'Falsch! Der Test startet neu.';
                wordDisplay.style.color = '#dc3545';
                wordsToTest = [...initialTestWords]; // Test auf Anfangszustand zur√ºcksetzen
                updateProgressDisplay();
                setTimeout(showNextTestWord, 2000); // Nach l√§ngerer Pause neu starten
            }
        };

        function startRecording() { 
            wasCorrect = false; 
            try { 
                // recognition.stop(); // Manchmal n√∂tig, um eine alte Aufnahme sicher zu beenden
                recognition.start(); 
            } catch(e) { console.error("Aufnahme konnte nicht gestartet werden."); } 
        }

        recognition.onend = () => { /* Diese Funktion wird nicht mehr f√ºr die Fehlerlogik ben√∂tigt */ };
        recognition.onerror = (event) => { 
            // Verhindern, dass der Timer eine "zu langsam"-Nachricht ausl√∂st, wenn es einen anderen Fehler gab
            if (event.error !== 'no-speech') {
                clearTimeout(timer);
                feedbackDisplay.textContent = "Mikrofon-Fehler.";
                console.error("Speech Recognition Error:", event.error);
                setTimeout(showNextTestWord, 1500);
            }
        };
        
        function populateLevelList() { /* ... unver√§ndert ... */ }
        function populateCustomLists() { /* ... unver√§ndert ... */ }
        
        function switchToTrainingMode() { 
            document.body.classList.remove('test-mode'); // Body-Klasse entfernen
            clearTimeout(timer); // Sicherstellen, dass kein Test-Timer l√§uft
            currentMode = 'training'; 
            progressDisplay.style.display = 'none'; 
            timerContainer.style.display = 'none'; // Timer ausblenden
            wordDisplay.style.color = 'black'; 
            feedbackDisplay.textContent = ''; 
            leftButton.textContent = 'Test'; 
            rightButton.textContent = 'N√§chstes Wort'; 
            showNewTrainingWord(); 
        }

        function handleLeftButtonClick() { if (currentMode === 'training') { switchToTestMode(); } else { switchToTrainingMode(); } }
        function handleRightButtonClick() { if (currentMode === 'training') { showNewTrainingWord(); } else { /* Button ist im Testmodus nicht sichtbar */ } }
        
        leftButton.addEventListener('click', handleLeftButtonClick); 
        rightButton.addEventListener('click', handleRightButtonClick);
        
        // Admin-Funktionen und Start-Funktion bleiben unver√§ndert
        function openAdminMenu() { /* ... unver√§ndert ... */ }
        topUiPanel.addEventListener('click', () => { /* ... unver√§ndert ... */ });
        function appStarten() { /* ... unver√§ndert ... */ }
        
        // Die unver√§nderten Funktionen hier zur Vollst√§ndigkeit
        populateLevelList = function() { levelList.innerHTML = ''; menuProgress.textContent = `Erreicht: Stufe ${hoechsteStufe} von ${stufen.length}`; for (let i = 1; i <= stufen.length; i++) { const item = document.createElement('div'); item.className = 'list-item'; item.textContent = `Stufe ${i}`; if (i > hoechsteStufe) { item.classList.add('locked'); } else { item.addEventListener('click', () => { ladeStufe(i, true); switchToTrainingMode(); sideMenu.classList.remove('open'); }); } levelList.appendChild(item); } }
        populateCustomLists = function() { customListContainer.innerHTML = ''; for (const listenName in customLists) { const item = document.createElement('div'); item.className = 'list-item'; item.textContent = listenName; if (localStorage.getItem(`customList_${listenName}_completed`) === 'true') { item.classList.add('completed'); } item.addEventListener('click', () => { ladeCustomList(listenName); switchToTrainingMode(); sideMenu.classList.remove('open'); }); customListContainer.appendChild(item); } }
        hamburgerButton.addEventListener('click', () => { populateLevelList(); populateCustomLists(); sideMenu.classList.toggle('open'); });
        openAdminMenu = function() { const pw = prompt("Admin-Passwort eingeben:"); if (pw !== ADMIN_PASSWORD) { alert("Falsches Passwort."); return; } const action = prompt("Aktion eingeben: 'reset' zum Zur√ºcksetzen, 'set' zum Setzen einer Stufe."); if (action && action.toLowerCase() === 'reset') { localStorage.clear(); alert("Fortschritt wurde zur√ºckgesetzt!"); location.reload(); } else if (action && action.toLowerCase() === 'set') { const newLevel = prompt("H√∂chste freigeschaltete Stufe eingeben:"); const levelNum = parseInt(newLevel); if (levelNum > 0 && levelNum <= stufen.length) { localStorage.setItem('hoechsteLeseStufe', levelNum); localStorage.setItem('aktuelleLeseStufe', levelNum); alert(`Fortschritt auf Stufe ${levelNum} gesetzt!`); location.reload(); } else { alert("Ung√ºltige Stufennummer."); } } }
        topUiPanel.addEventListener('click', () => { clearTimeout(adminTapTimer); adminTapCount++; if (adminTapCount >= 7) { adminTapCount = 0; openAdminMenu(); } adminTapTimer = setTimeout(() => { adminTapCount = 0; }, 1500); });
        appStarten = function() { const gespeicherteHoechsteStufe = localStorage.getItem('hoechsteLeseStufe'); const gespeicherteAktuelleStufe = localStorage.getItem('aktuelleLeseStufe'); hoechsteStufe = gespeicherteHoechsteStufe ? parseInt(gespeicherteHoechsteStufe) : 1; let startStufe = gespeicherteAktuelleStufe ? parseInt(gespeicherteAktuelleStufe) : 1; if (startStufe > hoechsteStufe) startStufe = hoechsteStufe; ladeStufe(startStufe); switchToTrainingMode(); }
        
        appStarten();
    </script>
</body>
</html>
